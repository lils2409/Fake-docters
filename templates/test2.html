<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MedFlow Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      .step-circle {
        width: 32px;
        height: 32px;
        border-radius: 9999px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        background-color: #e5e7eb; /* gray-200 */
        color: #6b7280;           /* gray-500 */
        border: 2px solid #d1d5db;/* gray-300 */
        z-index: 10;
      }

      .step-label {
        color: #9ca3af; /* gray-400 */
        font-weight: 500;
      }

      .stepper-item.active .step-circle {
        background-color: #10b981; /* green-500 */
        border-color: #10b981;
        color: #ffffff;
      }

      .stepper-item.active .step-label {
        color: #059669; /* green-600 */
      }
    </style>

</head>

<body class="bg-[#EAF7F8] h-screen overflow-hidden flex font-sans">

<!-- SIDEBAR -->
<aside class="w-64 bg-[#7FCBC3] flex flex-col px-6 py-8 h-screen overflow-hidden">

    <!-- LOGO -->
    <h1 class="text-3xl font-bold text-blue-600 mb-10">
        MED<span class="text-teal-700">FLOW</span>
    </h1>

    <!-- NAV -->
    <nav class="space-y-4 flex-1">
        <button onclick="showPage('dashboard', this)"
            class="nav-btn bg-white shadow">
            <i data-lucide="home"></i> Dashboard
        </button>

        <button onclick="showPage('add', this)" class="nav-btn">
            <i data-lucide="user-plus"></i> Add Patient
        </button>

        <button onclick="showPage('edit', this)" class="nav-btn">
            <i data-lucide="user-pen"></i> Edit Patient
        </button>

    </nav>

    <div class="border-t border-white/40 my-6"></div>

    <!-- LOGOUT -->
    <button onclick="logout()"
        class="flex items-center gap-3 text-red-600 font-semibold hover:bg-white/20 px-4 py-3 rounded-xl transition">
        <i data-lucide="log-out"></i> Log out
    </button>
</aside>

<!-- MAIN CONTENT -->
<main class="flex-1 p-6 overflow-y-auto">
<section class="bg-[#F6FBFC] rounded-3xl shadow-lg min-h-full p-8">

<!-- DASHBOARD -->
<div id="dashboard" class="page">
    <h2 class="text-2xl font-semibold mb-6">Dashboard</h2>

    <!-- TOP STATS -->
    <div class="grid grid-cols-3 gap-6 mb-10">
        <div class="bg-white rounded-2xl p-6 shadow">
            <p class="text-sm text-gray-500">Total Patients</p>
            <p id="totalPatients" class="text-4xl font-bold text-gray-900">0</p>
        </div>
        <div class="bg-white rounded-2xl p-6 shadow">
            <p class="text-sm text-gray-500">Waiting</p>
            <p id="waitingPatients" class="text-4xl font-bold text-yellow-500">0</p>
        </div>
        <div class="bg-white rounded-2xl p-6 shadow">
            <p class="text-sm text-gray-500">Done</p>
            <p id="donePatients" class="text-4xl font-bold text-green-600">0</p>
        </div>
    </div>

    <!-- TRIAGE LEVELS -->
    <h3 class="text-xl font-semibold mb-4">Triage Levels</h3>
    <div class="grid grid-cols-5 gap-4">
        <div class="triage bg-red-100 text-red-700">Red<br><span id="redCount">0</span></div>
        <div class="triage bg-yellow-100 text-yellow-700">Yellow<br><span id="yellowCount">0</span></div>
        <div class="triage bg-green-100 text-green-700">Green<br><span id="greenCount">0</span></div>
        <div class="triage bg-gray-100 text-gray-700">White<br><span id="whiteCount">0</span></div>
        <div class="triage bg-black text-white">Black<br><span id="blackCount">0</span></div>
    </div>
</div>
<!-- ADD PATIENT -->
<div id="add" class="page hidden bg-gray-50 min-h-screen py-12">

  <div class="max-w-6xl mx-auto px-6">

    <h2 class="text-3xl font-semibold text-gray-800 mb-10">
      Add New Patient
    </h2>

    <form method="POST" action="/add_patient" enctype="multipart/form-data">

      <div class="flex gap-16">

        <!-- STEP NAVIGATION -->
        <aside class="w-56 pt-4">
          <div class="space-y-10">

            <div class="stepper-item flex items-start gap-4" data-step="1">
              <div class="flex flex-col items-center">
                <div class="w-8 h-8 flex items-center justify-center rounded-full border border-gray-300 text-sm font-medium bg-white">
                  1
                </div>
                <div class="w-px h-16 bg-gray-200"></div>
              </div>
              <span class="text-sm text-gray-500 mt-1">General</span>
            </div>

            <div class="stepper-item flex items-start gap-4" data-step="2">
              <div class="flex flex-col items-center">
                <div class="w-8 h-8 flex items-center justify-center rounded-full border border-gray-300 text-sm font-medium bg-white">
                  2
                </div>
                <div class="w-px h-16 bg-gray-200"></div>
              </div>
              <span class="text-sm text-gray-500 mt-1">Medical</span>
            </div>

            <div class="stepper-item flex items-start gap-4" data-step="3">
              <div class="flex flex-col items-center">
                <div class="w-8 h-8 flex items-center justify-center rounded-full border border-gray-300 text-sm font-medium bg-white">
                  3
                </div>
              </div>
              <span class="text-sm text-gray-500 mt-1">Triage</span>
            </div>

          </div>
        </aside>

        <!-- FORM CARD -->
        <div class="flex-1">

          <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-10">

            <!-- STEP 1 -->
            <div class="step" data-step="1">

              <h3 class="text-lg font-semibold text-gray-800 mb-8">
                General Information
              </h3>

              <div class="grid grid-cols-2 gap-6">

                <input name="patient_id"
                  class="col-span-2 w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-teal-400 transition"
                  placeholder="Patient ID *" required>

                <input name="name"
                  class="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-teal-400 transition"
                  placeholder="First Name *" required>

                <input name="surname"
                  class="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-teal-400 transition"
                  placeholder="Surname *" required>

                <select name="sex"
                  class="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-teal-400 transition"
                  required>
                  <option value="">Sex *</option>
                  <option>Male</option>
                  <option>Female</option>
                  <option>Other</option>
                </select>

                <input type="number" name="age"
                  class="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-teal-400 transition"
                  placeholder="Age *" required>

                <input name="height"
                  class="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-teal-400 transition"
                  placeholder="Height (cm) *" required>

                <input name="weight"
                  class="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-teal-400 transition"
                  placeholder="Weight (kg) *" required>

              </div>

              <div class="flex justify-end mt-12">
                <button type="button"
                  onclick="nextStep(1)"
                  class="bg-teal-500 hover:bg-teal-400 text-white font-semibold px-8 py-3 rounded-xl shadow-sm transition">
                  Next →
                </button>
              </div>
            </div>

            <!-- STEP 2 -->
            <div class="step hidden" data-step="2">

              <h3 class="text-lg font-semibold text-gray-800 mb-8">
                Medical Information
              </h3>

              <div class="grid grid-cols-2 gap-6">

                <input name="chronic_disease"
                  class="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-teal-400 transition"
                  placeholder="Chronic Disease *" required>

                <input name="allergy"
                  class="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-teal-400 transition"
                  placeholder="Allergy *" required>

                <input name="blood_pressure"
                  class="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-teal-400 transition"
                  placeholder="Blood Pressure *" required>

                <input name="heart_rate"
                  class="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-teal-400 transition"
                  placeholder="Heart Rate *" required>

                <input name="blood_type"
                  class="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-teal-400 transition"
                  placeholder="Blood Type *" required>

              </div>

              <textarea name="case_desc"
                class="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-teal-400 transition mt-6"
                rows="3" placeholder="Case Description"></textarea>

              <textarea name="diagnosis"
                class="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-teal-400 transition mt-4"
                rows="3" placeholder="Diagnosis"></textarea>

              <div class="mt-8">
                <p class="text-sm font-medium text-gray-700 mb-4">
                  Imaging Required
                </p>

                <div class="grid grid-cols-3 gap-4 text-sm text-gray-700">

                  <label class="flex items-center gap-2">
                    <input type="checkbox" name="imaging[]" value="xray" class="accent-teal-500">
                    X-Ray
                  </label>

                  <label class="flex items-center gap-2">
                    <input type="checkbox" name="imaging[]" value="cbc" class="accent-teal-500">
                    CBC
                  </label>

                  <label class="flex items-center gap-2">
                    <input type="checkbox" name="imaging[]" value="ct_scan" class="accent-teal-500">
                    CT Scan
                  </label>

                  <label class="flex items-center gap-2">
                    <input type="checkbox" name="imaging[]" value="mri" class="accent-teal-500">
                    MRI
                  </label>

                  <label class="flex items-center gap-2">
                    <input type="checkbox" name="imaging[]" value="ultrasound" class="accent-teal-500">
                    Ultrasound
                  </label>

                </div>
              </div>

              <div class="flex justify-between mt-12">
                <button type="button"
                  onclick="prevStep()"
                  class="border border-gray-300 text-gray-700 px-8 py-3 rounded-xl hover:bg-gray-100 transition">
                  Back
                </button>

                <button type="button"
                  onclick="nextStep()"
                  class="bg-teal-500 hover:bg-teal-400 text-white font-semibold px-8 py-3 rounded-xl shadow-sm transition">
                  Next →
                </button>
              </div>
            </div>

            <!-- STEP 3 -->
            <div class="step hidden" data-step="3">

              <h3 class="text-lg font-semibold text-gray-800 mb-8">
                Triage
              </h3>

              <div class="flex items-center gap-6 mb-6">
                <div id="triageColor" class="w-12 h-12 rounded-xl bg-gray-200 border"></div>

                <select name="color_code"
                  class="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-teal-400 transition"
                  onchange="updateTriageColor(this.value)" required>
                  <option value="">Select Triage *</option>
                  <option>White</option>
                  <option>Green</option>
                  <option>Yellow</option>
                  <option>Red</option>
                  <option>Black</option>
                </select>
              </div>

              <textarea name="prescription"
                class="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-teal-400 transition"
                rows="3" placeholder="Prescription *" required></textarea>

              <div class="flex justify-between mt-12">
                <button type="button"
                  onclick="prevStep()"
                  class="border border-gray-300 text-gray-700 px-8 py-3 rounded-xl hover:bg-gray-100 transition">
                  Back
                </button>

                <button type="submit"
                  class="bg-teal-500 hover:bg-teal-400 text-white font-semibold px-8 py-3 rounded-xl shadow-sm transition">
                  Save Patient
                </button>
              </div>
            </div>

          </div>

        </div>
      </div>

    </form>

  </div>
</div>

<!-- EDIT PATIENT -->
<div id="edit" class="hidden page">
<h2 class="text-2xl font-semibold mb-6">Edit Patient</h2>

<!-- SEARCH -->
<input id="searchEdit"
    placeholder="Search by Patient ID or Name"
    class="input max-w-md mb-6"
    onkeyup="searchPatient()">

<!-- FORM -->
<div id="editForm" class="hidden space-y-6 max-w-3xl">

<div class="bg-white rounded-2xl p-6 shadow">
<h3 class="font-semibold mb-4">Basic Information</h3>
<div class="grid grid-cols-2 gap-4">
<input type="hidden" id="edit_id">

<input id="edit_patient_id" class="input" placeholder="Patient ID">
<input id="edit_name" class="input" placeholder="Name">
<input id="edit_surname" class="input" placeholder="Surname">

<select id="edit_sex" class="input">
<option>Male</option>
<option>Female</option>
<option>Other</option>
</select>

<input id="edit_age" type="number" class="input" placeholder="Age">
<input id="edit_height" class="input" placeholder="Height (cm)">
<input id="edit_weight" class="input" placeholder="Weight (kg)">
</div>
</div>

<div class="bg-white rounded-2xl p-6 shadow">
<h3 class="font-semibold mb-4">Medical Information</h3>
<div class="grid grid-cols-2 gap-4">
<input id="edit_chronic" class="input" placeholder="Chronic Disease">
<input id="edit_allergy" class="input" placeholder="Allergy">
<input id="edit_bp" class="input" placeholder="Blood Pressure">
<input id="edit_hr" class="input" placeholder="Heart Rate">
</div>

<textarea id="edit_case" class="input mt-4" rows="3" placeholder="Case Description"></textarea>
<textarea id="edit_diag" class="input mt-4" rows="3" placeholder="Diagnosis"></textarea>
</div>

<div class="bg-white rounded-2xl p-6 shadow">
<h3 class="font-semibold mb-4">Triage & Status</h3>

<div class="flex items-center gap-4 mb-4">
<div id="editTriageColor" class="w-10 h-10 rounded-xl border"></div>
<select id="edit_color"
    onchange="updateEditColor(this.value)"
    class="input flex-1">
<option>Red</option>
<option>Yellow</option>
<option>Green</option>
<option>White</option>
<option>Black</option>
</select>
</div>

<select id="edit_status" class="input">
<option>Waiting</option>
<option>Finish</option>
</select>

<textarea id="edit_prescription" class="input mt-4" rows="3" placeholder="Prescription"></textarea>
</div>

<button onclick="saveEdit()"
    class="w-full bg-teal-500 hover:bg-teal-400 text-white font-semibold py-4 rounded-2xl shadow transition">
Save Changes
</button>

</div>
</div>

<div id="status" class="page hidden">
<h2 class="text-2xl font-semibold">Update Status (Coming Soon)</h2>
</div>
</section>
</main>


<!-- STYLES -->
<style>
.nav-btn{
display:flex;gap:12px;align-items:center;width:100%;
padding:12px 16px;border-radius:12px;font-weight:600;
}
.nav-btn:hover{background:rgba(255,255,255,.4);}
.input{
width:100%;padding:12px 16px;border-radius:12px;
border:1px solid #D1D5DB;outline:none;
}
.input:focus{
border-color:#2DD4BF;
box-shadow:0 0 0 2px rgba(45,212,191,.3);
}
.triage{
text-align:center;padding:16px;border-radius:12px;font-weight:600;
}
.triage span{font-size:1.5rem;font-weight:700;}
</style>

<!-- SCRIPT -->
<script>
    let currentStep = 1;

function showStep(step) {
  // show form step
  document.querySelectorAll('.step').forEach(s => s.classList.add('hidden'));
  document.querySelector(`.step[data-step="${step}"]`).classList.remove('hidden');

  // update vertical stepper
  document.querySelectorAll('.stepper-item').forEach(item => {
    item.classList.remove('active');
    if (Number(item.dataset.step) === step) {
      item.classList.add('active');
    }
  });

  currentStep = step;
}

function nextStep() {
  const current = document.querySelector(`.step[data-step="${currentStep}"]`);
  const inputs = current.querySelectorAll('input, select, textarea');

  for (let input of inputs) {
    if (!input.checkValidity()) {
      input.reportValidity();
      return;
    }
  }

  showStep(currentStep + 1);
}

function prevStep() {
  showStep(currentStep - 1);
}

function updateTriageColor(value) {
  const box = document.getElementById('triageColor');
  const colors = {
    Red: '#ef4444',
    Yellow: '#facc15',
    Green: '#22c55e',
    White: '#e5e7eb',
    Black: '#000000'
  };
  box.style.backgroundColor = colors[value] || '#d1d5db';
}

// Run AFTER page loads
document.addEventListener('DOMContentLoaded', () => {
  showStep(1);
});
function showPage(id, btn){
document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden'));
document.getElementById(id).classList.remove('hidden');
document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('bg-white','shadow'));
btn.classList.add('bg-white','shadow');
}

function logout(){
    window.location.href = "/logout";
}


function updateEditColor(val){
const c={Red:"#F87171",Yellow:"#FACC15",Green:"#4ADE80",White:"#E5E7EB",Black:"#111827"};
document.getElementById("editTriageColor").style.background=c[val]||"#D1D5DB";
}

async function searchPatient(){
const q=document.getElementById("searchEdit").value;
if(q.length<2) return;

const r=await fetch(`/search_patient?q=${q}`);
const d=await r.json();
if(!d) return;

document.getElementById("editForm").classList.remove("hidden");

edit_id.value=d.id;
edit_patient_id.value=d.patient_id;
edit_name.value=d.name;
edit_surname.value=d.surname;
edit_sex.value=d.sex;
edit_age.value=d.age;
edit_height.value=d.height;
edit_weight.value=d.weight;

edit_chronic.value=d.chronic_disease;
edit_allergy.value=d.allergy;
edit_bp.value=d.blood_pressure;
edit_hr.value=d.heart_rate;
edit_case.value=d.case_desc;
edit_diag.value=d.diagnosis;

edit_color.value=d.color_code;
edit_status.value=d.status;
edit_prescription.value=d.prescription;

updateEditColor(d.color_code);
}

async function saveEdit(){
await fetch("/update_patient",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({
id:edit_id.value,
patient_id:edit_patient_id.value,
name:edit_name.value,
surname:edit_surname.value,
sex:edit_sex.value,
age:edit_age.value,
height:edit_height.value,
weight:edit_weight.value,
chronic_disease:edit_chronic.value,
allergy:edit_allergy.value,
blood_pressure:edit_bp.value,
heart_rate:edit_hr.value,
case_desc:edit_case.value,
diagnosis:edit_diag.value,
color_code:edit_color.value,
status:edit_status.value,
prescription:edit_prescription.value
})
});

alert("Patient updated successfully");
}

async function loadStats(){
    const res = await fetch("/stats");
    const data = await res.json();

    document.getElementById("totalPatients").innerText = data.total;
    document.getElementById("waitingPatients").innerText = data.waiting;
    document.getElementById("donePatients").innerText = data.done;

    document.getElementById("redCount").innerText = data.colors.Red;
    document.getElementById("yellowCount").innerText = data.colors.Yellow;
    document.getElementById("greenCount").innerText = data.colors.Green;
    document.getElementById("whiteCount").innerText = data.colors.White;
    document.getElementById("blackCount").innerText = data.colors.Black;
}

loadStats();

lucide.createIcons();

document.addEventListener("DOMContentLoaded", () => {
  showPage("dashboard", document.querySelector(".nav-btn"));
});
</script>

</body>
</html>